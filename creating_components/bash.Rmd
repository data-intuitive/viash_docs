---
title: "Creating a Bash component"
parent: Creating components
---

```{r init, include=FALSE}
library(tidyverse)

source("../src/helper/md_helpers.R")

# change wd to where the files are located
knitr::opts_knit$set(root.dir = "../examples/md_url_checker/") 
# Remove hashtags before bash output
knitr::opts_chunk$set(comment = NA)
```

# Developing a new viash component

In this tutorial, you'll create a component that does the following:

- Extract all hyperlinks from a markdown file
- Check if every URL is reachable
- Create a text report with the results 

The component will be able to run locally and as a docker container.
In order to create a component you need two files: a script for the functionality and a config file that describes the component.
  
The files used in this tutorial can be found here:

[https://github.com/data-intuitive/viash_docs/examples/check_if_URLS_reachable](https://github.com/data-intuitive/viash_docs/examples/check_if_URLS_reachable)

## Prerequisites

To follow along with this tutorial, you need to have this software installed on your machine:

- An [installation of viash](/getting_started/installation).
- A **Unix shell** like Bash or Zsh.
- An installation of [cURL](https://curl.se/). Install this via your package manager if you don't have it installed yet.

We recommend you take a look at the [hello world example](/getting_started/hello_world_bash) first to understand how components work.

## Write a script in Bash

The first step of developing this component, is writing the core functionality of the component, in this case a bash script.  
Create a new folder named **my_viash_component** and open it. Now create a new file named **script.sh** in there and add this code as its content:

```{r, echo = FALSE}
print_file("script.sh", format = "bash", show_filename = FALSE)
```
 
Note the numbered comments scattered about looking like `### x ###`,  here's a breakdown of the code:

1. The variables are placed between `## VIASH START` and `## VIASH END` for debugging purposes, their final values will be dynamically generated by viash once the script is turned into a component. If you want to skip the testing of your script, you can leave these out and viash will create variables based on the configuration file.
There are three variables:
    * `par_inputfile`: The markdown file that needs to be parsed.
    * `par_domain`: The domain URL that gets inserted before any relative URLs. For example, "/documentation/intro" could be replaced with "https://my-website/documentation/intro" to create a valid URL.
    * `par_output`: The path of the output text file that will contain the report.
2. The script parses the markdown file and extracts the hyperlink titles and URLs using some nifty [sed](https://www.gnu.org/software/sed/manual/sed.html) regex. It then puts those strings into two arrays for later use.
3. Start a for-loop to iterate the title array.
4. Any relative URLs (or those that don't start with "http" at least) will get the domain added before it.
5. cURL is used to check for a response from the URL. The resulting status code is stored and compared to the expected code. The results get written to the terminal and the report.


## Test the script

Before turning the script into a component, it's a good idea to test if it actually works as expected.  
As the script expects a markdown file with hyperlinks, create a new file in the script folder named **Testfile.md** and paste in the following:

```{r, echo = FALSE}
print_file("Testfile.md", format = "markdown", show_filename = FALSE)
```

Now open a terminal in the **my_viash_component** folder and execute the following command to make your script executable:

```{bash, eval=FALSE}
chmod +x ./script.sh
```

Next, run the script by executing this command:

```{bash, eval=FALSE}
./script.sh
```

The script will now show the following output:

```{bash, echo=FALSE}
./script.sh
```

If you get this same output, that means the script is working as intended! Feel free to take a peek at the generated **output.txt** file as well.
You might have noticed you didn't have to provide any arguments, that's because the values are hard-coded into the script for debugging purposes.  
  
Now the script has been tested, it's time to create a config file to describe the component based on it. 

## Describe the component using YAML

A **viash config file** is a [YAML](https://yaml.org/) file that describes the behavior and supported platforms of a viash component. 
Create new file named **config.vsh.yaml** and paste the following template inside of it:  

```{r, echo = FALSE}
print_file("../../templates/minimalconfig.vsh.yaml", format = "yaml", show_filename = FALSE)
```

Every config file requires these two dictionaries: [functionality](http://www.data-intuitive.com/viash_docs/getting_started/hello_world_bash/#functionality) and [platforms](http://www.data-intuitive.com/viash_docs/getting_started/hello_world_bash/#platforms). 
This bare-bones config file makes it easy to "fill in the blanks" for this example. For more information about config files, you can take a look at the [Config](/config) page. 

Let's start off by defining the functionality of our component.

### Defining the functionality

The **functionality** dictionary describes what the component does and the resources it needs to do so. 
The first key is **name**, this will be the name of the component once it's built. Replace the **NAME** value with **md_url_checker** or any other name of your choosing.  

Next up is the **description** key, its value will be printed out at the top when the **--help** command is called. Replace **DESCRIPTION** with "**Check if URLs in a markdown are reachable and create a text report with the results.**". You can use multiple lines for a description by starting its value with a pipe (|) and a new line, like so:

```yaml
functionality:
  name: md_url_checker
  description: |
    This is the first line of my description.
    Here's a second line!
```

The **arguments** dictionary contains all of the arguments that are accepted by the component. These arguments will be injected as variables in the script. In the case of the example script, this are the variables we're working with:

* `par_inputfile`
* `par_domain`
* `par_output`

To create good arguments, you need to ask yourself a few essential questions about each variable:

- What is the most fitting [data type](config/functionality/#arguments-list)? 
- What is an appropriate name?
- How would I describe this variable?
- Is it required?



### Defining the platforms

What platforms do you want the component to run on and what are the dependencies?

native = for developers that know what they're doing or for simple components without any dependancies
docker = recommended for most components, the dependencies are resolved by using docker containers, either from scratch or by pulling one from a docker repository. This has huge benefits as the end user doesn't need to have any of the dependencies installed locally.
nextflow = this converts the component into NextFlow module that can be imported into a pipeline

This example component will support both the native and docker platform

### Creating a final config file

The end result should look like this:

```{r, echo = FALSE}
print_file("config.vsh.yaml", format = "yaml", show_filename = FALSE)
```

## Run the component

You can now also use one of your own markdown files as the input. In that case, replace **Testfile.md** in the command with the path to your file.

## Building an executable




#### Write a script in Bash
This is a simple script which prints a simple message, along with any input provided to it through the `par_input` parameter.
Optionally, you can override the greeter with `par_greeter`.



Anything between the `## VIASH START` and `## VIASH END` lines will automatically be replaced 
at runtime with parameter values from the CLI. Anything between these two lines can be used to 
test the script without viash:

```{bash}
./script.sh
```

Next, we write a meta-file describing the functionality of this component in YAML format.

#### Describe the component with as a YAML

A [viash config](/config) file describes the behaviour of a script and the platform it runs on.
It consists of two main sections: `functionality` and `platforms`.


```{r, echo = FALSE}
print_file("config.vsh.yaml", "yaml")
```

The [functionality](config/functionality) section describes the core functionality of the component, such as 
its inputs, outputs, arguments, and extra resources. For each of the arguments, specifying
a description and a set of argument restrictions help create a useful command-line interface.
To ensure that your component works as expected, writing one or more tests is essential.

The platforms section specifies the requirements to execute the component on zero or more platforms.
The list of currently supported platforms are [Native](config/platform-native), [Docker](config/platform-docker),
and [Nextflow](config/platform-nextflow). If no platforms are specified, a native platform with no 
system requirements is assumed.


### Writing a first unit test
Writing a unit test for a viash component is relatively simple. 
You just need to write a Bash script (or R, or Python) which runs the executable multiple
times, and verifies the output. Take note that the test needs to produce an error code not equal to
0 when a mistake is found.

TODO: Add unit test

When running the test, viash will automatically build an executable and place it -- along with other 
resources and test resources -- in a temporary working directory.

```{bash cleanup, echo=FALSE}
rm -r output.txt
```
